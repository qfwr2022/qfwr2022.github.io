<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>ç¬¬7è®² è¿­ä»£</title>
    <meta charset="utf-8" />
    <meta name="author" content=" æ›¾æ°¸è‰º" />
    <meta name="date" content="2022-11-18" />
    <script src="../libs/header-attrs/header-attrs.js"></script>
    <link href="../libs/tile-view/tile-view.css" rel="stylesheet" />
    <script src="../libs/tile-view/tile-view.js"></script>
    <link href="../libs/tachyons/tachyons.min.css" rel="stylesheet" />
    <link href="../libs/panelset/panelset.css" rel="stylesheet" />
    <script src="../libs/panelset/panelset.js"></script>
    <script src="../libs/freezeframe/freezeframe.min.js"></script>
    <script src="../libs/xaringanExtra-freezeframe/freezeframe-init.js"></script>
    <script id="xaringanExtra-freezeframe-options" type="application/json">{"selector":"img[src$=\"gif\"]","trigger":"click","overlay":false,"responsive":false,"warnings":true}</script>
    <script type="application/json" id="xaringanExtra-editable-docid">{"id":"a525bb21b5c843e8b037e2f24ab8d2a7","expires":7}</script>
    <script src="../libs/himalaya/himalaya.js"></script>
    <script src="../libs/js-cookie/js.cookie.js"></script>
    <link href="../libs/editable/editable.css" rel="stylesheet" />
    <script src="../libs/editable/editable.js"></script>
    <link href="../libs/xaringanExtra-extra-styles/xaringanExtra-extra-styles.css" rel="stylesheet" />
    <link href="../libs/animate.css/animate.xaringan.css" rel="stylesheet" />
    <script src="../libs/clipboard/clipboard.min.js"></script>
    <link href="../libs/xaringanExtra-clipboard/xaringanExtra-clipboard.css" rel="stylesheet" />
    <script src="../libs/xaringanExtra-clipboard/xaringanExtra-clipboard.js"></script>
    <script>window.xaringanExtraClipboard(null, {"button":"<i class=\"fa fa-copy\"><\/i>","success":"<i class=\"fa fa-check\" style=\"color: #90BE6D\"><\/i>","error":"<i class=\"fa fa-times-circle\" style=\"color: #F94144\"><\/i>"})</script>
    <link href="../libs/font-awesome/css/all.css" rel="stylesheet" />
    <link href="../libs/font-awesome/css/v4-shims.css" rel="stylesheet" />
    <link rel="stylesheet" href="../libs/zen-styles-v2.3.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# é‡åŒ–é‡‘èä¸é‡‘èç¼–ç¨‹
]
.subtitle[
## L07 è¿­ä»£
]
.author[
### <br>æ›¾æ°¸è‰º
]
.institute[
### å¦é—¨å¤§å­¦ç®¡ç†å­¦é™¢
]
.date[
### <br>2022-11-18
]

---

class: middle, hide_logo
background-image: url(imgs/logo-purrr.png)
background-size: 25%
background-position: 15% 50%



<div>
<style type="text/css">.xaringan-extra-logo {
width: 50px;
height: 50px;
z-index: 0;
background-image: url(imgs/logo-sm.png);
background-size: contain;
background-repeat: no-repeat;
position: absolute;
top:0.5em;right:0.5em;
}
</style>
<script>(function () {
  let tries = 0
  function addLogo () {
    if (typeof slideshow === 'undefined') {
      tries += 1
      if (tries < 10) {
        setTimeout(addLogo, 100)
      }
    } else {
      document.querySelectorAll('.remark-slide-content:not(.title-slide):not(.inverse):not(.hide_logo)')
        .forEach(function (slide) {
          const logo = document.createElement('div')
          logo.classList = 'xaringan-extra-logo'
          logo.href = null
          slide.appendChild(logo)
        })
    }
  }
  document.addEventListener('DOMContentLoaded', addLogo)
})()</script>
</div>

.pull-right.font200[

1. æ§åˆ¶æµç»“æ„

2. å‡½æ•°å¼ç¼–ç¨‹

3. `purrr` åŒ… 

4. `purrr` åŒ… ä¸ åˆ—è¡¨åˆ—

5. `purrr` -&gt; `furrr`

]

---
layout: false
class: inverse, center, middle

# 1. æ§åˆ¶æµç»“æ„

.font150[( _control-flow constructs in R_ )]

---
class: middle

.font150.bold[

&gt; æ—¥å‡ºæ—¥è½ï¼Œæœˆåœ†æœˆç¼ºï¼Œå¹´å°¾å¹´å¤´ï¼Œè¿™æ˜¯â€œ.red[å¾ªç¯]â€ï¼›  
&gt; 
&gt; ä¸Šå­¦è¿˜æ˜¯å°±ä¸šï¼Œå•èº«è¿˜æ˜¯ç»“å©šï¼Œä¸å…‹è¿˜æ˜¯ç”Ÿå¨ƒï¼Œè¿™æ˜¯â€œ.red[åˆ†æ”¯]â€ï¼›  
&gt; 
&gt; ä¸ç®¡æ˜¯å¾ªç¯è¿˜æ˜¯åˆ†æ”¯ï¼Œéƒ½åµŒå…¥åœ¨ç”Ÿè€ç—…æ­»çš„æ—¶é—´è½´ä¸Šï¼Œè¿™æ˜¯â€œ.red[é¡ºåº]â€ï¼› 
&gt; 
&gt; æ‰€è°“å°½äººäº‹å¬å¤©å‘½ï¼Œæƒ³æ¥å°±æ˜¯å¿ƒå¹³æ°”å’Œåœ°æ¥å—é¡ºåºç»“æ„ï¼Œå°å¿ƒç¿¼ç¿¼åœ°åˆ¶å®šå¾ªç¯ç»“æ„ï¼Œåœ¨å…³é”®æ—¶åˆ»æ§åˆ¶å¥½åˆ†æ”¯ç»“æ„ï¼Œå°±è¿™æ ·åº¦è¿‡ä¸€ç”Ÿç½¢ã€‚ 
&gt; &lt;br&gt;&lt;br&gt;
&gt;                       .right[â€”â€” å¤§é¹å¿—ï¼Œè½¬å¼•è‡ªã€Šå­¦Rã€‹]

]

---
layout: true

### &gt;&gt; 1.1 `for` å¾ªç¯ç»“æ„

---

.full-width[.content-box-blue.bold.font120[`for` å¾ªç¯å±äºå‘½ä»¤å¼ç¼–ç¨‹ï¼ˆ_imperative programming_ï¼‰ä¸­çš„é‡å¤æ‰§è¡ŒèŒƒå¼]]
--

.pull-left.code90[

```r
library(tidyverse)
set.seed(1234)
df &lt;- tibble(
  a = rnorm(10),
  b = rnorm(10),
  c = rnorm(10)
)
```
]

.pull-right.code90[

```r
# è®¡ç®—å„åˆ—çš„å‡å€¼
mean(df$a)
mean(df$b)
mean(df$c)
```

```
#&gt; [1] -0.383
#&gt; [1] -0.118
#&gt; [1] -0.388
```
]

--

.code90[

```r
# forå¾ªç¯çš„ä¸‰ä¸ªç»„æˆéƒ¨åˆ†
output &lt;- vector("double", ncol(df))  # 1. output    è¾“å‡º
for(i in seq_along(df)) {             # 2. sequence  å¾ªç¯åºåˆ—
  output[[i]] &lt;- mean(df[[i]])        # 3. body      å¾ªç¯ä½“
}
output
```

```
#&gt; [1] -0.383 -0.118 -0.388
```
]

---

.full-width[.content-box-blue.bold.font120[`for` å¾ªç¯çš„ä¸‰ç§æ¨¡å¼]]

--

- `for(x in xs)`ï¼šé€ä¸ªå…ƒç´ å¾ªç¯ï¼Œå½“ä½ åªå…³æ³¨å‰¯ä½œç”¨ï¼ˆå¦‚ä½œå›¾ã€å­˜ç›˜ï¼‰æ—¶ï¼Œè¿™æ˜¯æœ€æœ‰ç”¨çš„æ¨¡å¼
  
--

- `for(nm in names(xs))`ï¼šé€ä¸ªåå­—å¾ªç¯ï¼Œåœ¨å¾ªç¯ä½“ä¸­ç”¨ `xs[[nm]]` å¾—åˆ°å‘½åå‘é‡ `xs` å…ƒç´ çš„å€¼ã€‚ä½ è¿˜å¯ä»¥è®©è¾“å‡ºçš„åå­—å’Œè¾“å…¥çš„åå­—å¯¹åº”èµ·æ¥ï¼š
  
&gt; .code80[

```r
output &lt;- vector("list", length(xs))
*names(output) &lt;- names(xs)
for(nm in names(xs)) {
  output[[nm]] &lt;- .f(xs[[nm]], ...)
}
```
]

--

- `for(i in seq_along(xs))`ï¼šé€ä¸ªæ•°å€¼ç´¢å¼•å¾ªç¯ï¼Œè¿™æ˜¯æœ€é€šç”¨çš„æ¨¡å¼ã€‚ä¸‹é¢è¯­å¥ä¼šç»™å‡ºå…ƒç´ çš„åå­—å’Œå–å€¼ï¼š
  
&gt; .code80[

```r
for(i in seq_along(xs)) {
  name &lt;- names(xs)[[i]]
  value &lt;- xs[[i]]
  # ...
}
```
]


---

.full-width[.content-box-blue.bold.font120[ç‰¹æ®Šæƒ…å†µï¼š_â€œå°±åœ°â€_ä¿®æ”¹]]

--

.code100[


```r
rescale01 &lt;- function(x) {
  rng &lt;- range(x, na.rm = TRUE)
  (x - rng[1]) / (rng[2] - rng[1])
}
```


```r
# outputï¼ˆè¾“å‡ºï¼‰å·²å¤‡
# åœ¨bodyï¼ˆå¾ªç¯ä½“ï¼‰ä¸­ç›´æ¥è°ƒç”¨`[[&lt;-`å®Œæˆâ€œå°±åœ°â€ä¿®æ”¹ x           #]#]
for(i in seq_along(df)) {
* df[[i]] &lt;- rescale01(df[[i]])  # ä¸è¦ä½¿ç”¨[]
}
df
```

```
#&gt; # A tibble: 10 Ã— 3
#&gt;       a      b     c
#&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
#&gt; 1 0.332 0.153  0.782
#&gt; 2 0.765 0      0.473
#&gt; 3 1     0.0651 0.498
#&gt; # â€¦ with 7 more rows
```
]

---

.full-width[.content-box-blue.bold.font120[ç‰¹æ®Šæƒ…å†µï¼šäº‹å‰æ— æ³•ç¡®å®š_è¾“å‡º_çš„é•¿åº¦]]

--

.pull-left.code90[


```r
# **ä½æ•ˆçš„åšæ³•**
set.seed(1234)
means &lt;- c(0, 1, 2)
*out &lt;- double()  # ç©ºçš„å®æ•°å‘é‡
for(i in seq_along(means)) {
  n &lt;- sample(100, 1)
  print(glue::glue("L#{i}: n={n}"))
* out &lt;- c(out,
*          rnorm(n, means[[i]]))
}
```

```
#&gt; L#1: n=28
#&gt; L#2: n=79
#&gt; L#3: n=2
```

```r
str(out, vec.len = 2.5)
```

```
#&gt;  num [1:109] 0.312 0.314 0.359 ...
```
]

--

.pull-right.code90[

```r
# **æ›´å¥½çš„åšæ³•**
# ä½¿ç”¨æ›´å¤æ‚çš„æ•°æ®ç»“æ„ï¼Œå®Œæˆå¾ªç¯åå†å¤„ç†
set.seed(1234)
means &lt;- c(0, 1, 2)
*out &lt;- vector("list", length(means))
for(i in seq_along(means)) {
  n &lt;- sample(100, 1)
  print(glue::glue("L#{i}: n={n}"))
* out[[i]] &lt;- rnorm(n, means[[i]])
}
*out &lt;- unlist(out)
# purrr::flatten_dbl(out)
str(out, vec.len = 2.5)
```

```
#&gt; L#1: n=28
#&gt; L#2: n=79
#&gt; L#3: n=2
#&gt;  num [1:109] 0.312 0.314 0.359 ...
```

]

---
layout: false

### &gt;&gt; .gray[1.1 `for` å¾ªç¯ç»“æ„ +] 1.2 `if` åˆ†æ”¯ç»“æ„

.full-width[.content-box-blue.bold.font120[ç‰¹æ®Šæƒ…å†µï¼šäº‹å‰æ— æ³•ç¡®å®š_å¾ªç¯_çš„æ¬¡æ•° -&gt; `while()` / `repeat` + `break`]]

--

.code90[

```r
flip &lt;- function() sample(c("T", "H"), 1)
```
]

.pull-left.code90[


```r
set.seed(111)
nheads &lt;- 0
flips &lt;- character()
*while(nheads &lt; 3) {
  H_T &lt;- flip()
* if(H_T == "H") {
    nheads &lt;- nheads + 1
* } else {
    nheads &lt;- 0  # é‡æ–°è®¡æ•°
  }
  flips &lt;- c(flips, H_T)
}
flips
```

```
#&gt;  [1] "H" "T" "H" "T" "T" "T" "T"
#&gt;  [8] "T" "T" "H" "H" "H"
```
]

--

.pull-right.code90[

```r
set.seed(111)
nheads &lt;- 0
flips &lt;- character()
*repeat {
  H_T &lt;- flip()
  if(H_T == "H") {
    nheads &lt;- nheads + 1
  } else {
    nheads &lt;- 0  # é‡æ–°è®¡æ•°
  }
  flips &lt;- c(flips, H_T)
* if(nheads &gt;= 3) break
}
flips
```

```
#&gt;  [1] "H" "T" "H" "T" "T" "T" "T"
#&gt;  [8] "T" "T" "H" "H" "H"
```
]

---
layout: false
class: inverse, center, middle

# 2. å‡½æ•°å¼ç¼–ç¨‹

.font150[( _functional programming_ )]

---
layout: false

### &gt;&gt; 2.1 R è¯­è¨€ä¸å‡½æ•°å¼ç¼–ç¨‹

.full-width[.content-box-blue.bold.font120[R è¯­è¨€çš„æ ¸å¿ƒå…¶å®æ˜¯ä¸€ç§å‡½æ•°å¼ç¼–ç¨‹ï¼ˆ_functional programming_ï¼‰è¯­è¨€ï¼Œå¯é€šè¿‡æä¾›å‘é‡åŒ–å‡½æ•°å’Œå‡½æ•°å¼ç¼–ç¨‹å·¥å…·ï¼Œé¿å…ç›´æ¥è°ƒç”¨ `for` å¾ªç¯ï¼Œå‡å°‘ä»£ç é‡å¤å¹¶æé«˜ä»£ç çš„å¯è¯»æ€§]]

--

.pull-left.code80[

```r
# å®šä¹‰å‡½æ•°ï¼Œè®¡ç®—æ•°æ®æ¡†æ¯åˆ—çš„å‡å€¼
col_mean &lt;- function(df) {
  out &lt;- vector("double", length(df))
  for(i in seq_along(df)) {
    out[i] &lt;- mean(df[[i]])
  }
  out
}
# è°ƒç”¨å‡½æ•°
col_mean(df)
```

```
#&gt; [1] 0.572 0.258 0.524
```

.font110.bold[ğŸ¤” è¯¥å¦‚ä½•ä¸€èˆ¬åŒ– `col_`.red[`mean`]`()`ï¼Ÿ]

.font110.bold[ğŸ¤© å®šä¹‰ `col_median()`ã€`col_sd()` ...ï¼Ÿ]

.font110.bold[ğŸ™… NOPE! æ›´å¥½çš„åšæ³•æ˜¯ -&gt; ]
]

--

.pull-right.code85[

```r
# ... ä½¿ç”¨å‡½æ•°å¼ç¼–ç¨‹
# å‡½æ•°ä½œä¸ºå‚æ•° -&gt; æ³›å‡½
*col_summary &lt;- function(df, .fun) {
  out &lt;- vector("double", length(df))
  for(i in seq_along(df)) {
*   out[i] &lt;- .fun(df[[i]])
  }
  out
}
```


```r
col_summary(df, mean)
```

```
#&gt; [1] 0.572 0.258 0.524
```

```r
col_summary(df, sd)
```

```
#&gt; [1] 0.290 0.313 0.329
```
]

---
layout: false

### &gt;&gt; 2.2 `apply` æ—å‡½æ•° &amp; `Reduce()` ç­‰é«˜é˜¶å‡½æ•°

.font95[
- `apply(X, MARGIN, FUN, ...)`    
  `sweep(x, MARGIN, STATS, FUN = "-", check.margin = TRUE, ...)`
  
- `lapply(X, FUN, ...)`    
  `sapply(X, FUN, ..., simplify = TRUE, USE.NAMES = TRUE)`    
  `vapply(X, FUN, FUN.VALUE, ..., USE.NAMES = TRUE)`    
  `rapply(object, f, classes = "ANY", deflt = NULL, how = c("unlist", "replace", "list"), ...)`   
  `replicate(n, expr, simplify = "array")`    
  `mapply(FUN, ..., MoreArgs = NULL, SIMPLIFY = TRUE, USE.NAMES = TRUE)`    
  `eapply(env, FUN, ..., all.names = FALSE, USE.NAMES = TRUE)` 
  
- `tapply(X, INDEX, FUN = NULL, ..., default = NA, simplify = TRUE)`    
  `by(data, INDICES, FUN, ..., simplify = TRUE)`    
  `aggregate(x, by, FUN, ..., simplify = TRUE, drop = TRUE)` ...
  
- `Reduce(f, x, init, right = FALSE, accumulate = FALSE)`    
  `Filter(f, x)`    
  `Find(f, x, right = FALSE, nomatch = NULL)`    
  `Map(f, ...)`    
  `Position(f, x, right = FALSE, nomatch = NA_integer_)`
]

---
layout: false
class: inverse, center, middle

# 3. `purrr` åŒ… &lt;sup&gt;.font60[v0.3.5]&lt;/sup&gt;

.font150[( _Functional Programming Tools_ )]

---
layout: true

### &gt;&gt; 3.1 `purrr` åŒ…çš„ `map` æ—å‡½æ•°

---

.full-width[.content-box-blue.bold.font120[`map` æ—å‡½æ•°ï¼š_"Learn it once, use it everywhere!" - Jenny Bryan_]]

&lt;img src="imgs/map_family.png" width="80%" style="display: block; margin: auto;" /&gt;

--

.font100[
- **å‚æ•°ç»Ÿä¸€**ï¼š`map()`ã€`map_*()`ã€`modify()` å’Œ `walk()` å‡½æ•°çš„ç¬¬1ä¸ªå‚æ•° `.x` ä¸ºè¾“å…¥å‘é‡ï¼ˆåŒ…æ‹¬åŸå­å‘é‡å’Œåˆ—è¡¨ï¼‰ï¼Œç¬¬2ä¸ªå‚æ•° `.f` ä¸ºå‡½æ•°ï¼Œç¬¬3ä¸ªå‚æ•° `...` ä¸ºä¼ é€’ç»™ `.f` çš„é¢å¤–å‚æ•°ã€‚
]

--

.font100[
- **è¿”å›ç»“æœä¸€ç›®äº†ç„¶**ï¼š`map()`ã€`map_*()`ã€`modify()` å’Œ `walk()` çš„è¿”å›ç»“æœå‡ä¸ºä¸è¾“å…¥å‘é‡ç­‰é•¿çš„å‘é‡ï¼Œ`map()` è¿”å›åˆ—è¡¨ï¼Œ`map_*()` è¿”å›å‘é‡çš„ç±»ç”±å‡½æ•°åä¸­çš„åç¼€å†³å®šï¼Œ`modify()` è¿”å›ä¸è¾“å…¥å‘é‡åŒç±»çš„è¾“å‡ºï¼Œè€Œ `walk()` åˆ™ä¸å¯è§åœ°è¿”å›è¾“å…¥å‘é‡ã€‚
]

--

.font100[
- **ä¸€é€šç™¾é€š**ï¼šè¾“å…¥æ‰©å±•è‡³2ä¸ªå‘é‡ï¼ˆå¦‚ `map2(.x, .y, .f, ...)`ï¼‰å’Œå¤šä¸ªå‘é‡æ„æˆçš„åˆ—è¡¨ `.l`ï¼ˆå¦‚ `pmap(.l, .f, ...)`ï¼‰ï¼Œè¿˜å¯åŒæ—¶åº”ç”¨äºå‘é‡å…ƒç´ å’Œç´¢å¼•ï¼ˆå¦‚ `imap(.x, .f, ...)`ï¼‰ã€‚
]

---

.pull-left[

&lt;img src="imgs/map-arg.png" width="75%" /&gt;


```r
map(df, mean)         # è¿”å›åˆ—è¡¨
```

```
#&gt; $a
#&gt; [1] 0.572
#&gt; 
#&gt; $b
#&gt; [1] 0.258
#&gt; 
#&gt; $c
#&gt; [1] 0.524
```


```r
map_dbl(df, mean)       # è¿”å›å®æ•°å‘é‡
# df %&gt;% map_dbl(mean)  # æ”¯æŒç®¡é“æ“ä½œ
```

```
#&gt;     a     b     c 
#&gt; 0.572 0.258 0.524
```

]

--

.pull-right[

.full-width[.content-box-blue.bold.font120[å’Œ `for` å¾ªç¯æ¯”]]

.font100[

- ç”¨å‡½æ•°å¼ç¼–ç¨‹å‡½æ•°æ¥å®Œæˆå¾ªç¯ï¼Œæ›´åŠ ç®€æ´

- å…³æ³¨å®Œæˆè¿ç®—çš„å‡½æ•°ï¼ˆå¦‚ `mean`ï¼‰ï¼Œè€Œéå‡†å¤‡æ€§æ­¥éª¤ï¼ˆå¦‚å®šä¹‰è¾“å‡º `output`ï¼‰

- é€‚åˆç”¨ `%&gt;%` å°†ä¸åŒå‡½æ•°é“¾æ¥èµ·æ¥è§£å†³é—®é¢˜

- -&gt; ä»£ç æ›´åŠ æ˜“è¯»ã€æ˜“å†™ã€æ˜“ç”¨

]

&lt;br&gt;

.full-width[.content-box-blue.bold.font120[å’Œè‡ªè¡Œç¼–å†™çš„ `col_summary()` æ¯”]]

.font100[

- åå°ç”¨ C ç¼–å†™ï¼Œæ•ˆç‡æ›´é«˜

- å‚æ•° `.f` æ”¯æŒå‡½æ•°ã€å…¬å¼ã€å­—ç¬¦|æ•´æ•°å‘é‡

- ç»“æœä¿ç•™å…ƒç´ çš„åç§°

]

.font150.center[ğŸ‘ â¤ï¸ âœŒï¸]
]

---

.full-width[.content-box-blue.bold.font120[`map` æ—å‡½æ•°çš„å‚æ•° `.f` æ”¯æŒå¿«æ·å†™æ³•]]

--

.pull-left.code90[

```r
# åŒ¿åå‡½æ•°
models &lt;- mtcars %&gt;% 
  split(.$cyl) %&gt;%  # å¾—åˆ°3ä¸ªå‘½ååˆ—è¡¨
* map(function(df)
*       lm(mpg ~ wt, data = df))
# map(\(df) lm(mpg ~ wt, data = df))

# å°†åŒ¿åå‡½æ•°æ”¹å†™ä¸ºå•ä¾§å…¬å¼
models &lt;- mtcars %&gt;% 
  split(.$cyl) %&gt;% 
* map(~ lm(mpg ~ wt, data = .x))

str(models, max.level = 1)
```

```
#&gt; List of 3
#&gt;  $ 4:List of 12
#&gt;   ..- attr(*, "class")= chr "lm"
#&gt;  $ 6:List of 12
#&gt;   ..- attr(*, "class")= chr "lm"
#&gt;  $ 8:List of 12
#&gt;   ..- attr(*, "class")= chr "lm"
```
]

--

.pull-right.code100[

```r
# å•ä¾§å…¬å¼
models %&gt;% 
  map(summary) %&gt;% 
* map_dbl(~ .x$r.squared)
```

```
#&gt;     4     6     8 
#&gt; 0.509 0.465 0.423
```


```r
# ç›´æ¥ä½¿ç”¨ å­—ç¬¦å‘é‡ æå–å…ƒç´ 
# ç»“æœåŒä¸Šï¼Œä»ç•¥
models %&gt;% 
  map(summary) %&gt;% 
* map_dbl("r.squared")

# è‹¥ä½ çŸ¥é“å…ƒç´ çš„å…·ä½“ä½ç½®ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç”¨
# æ•´æ•°æå–å…ƒç´ ï¼Œä½†ä¸æ¨è
```
]

---

.full-width[.content-box-blue.bold.font120[å¤šä¸ªè¾“å…¥ï¼š.red[`map2(.x, .y, .f, ...)`]ã€`pmap()` å’Œ `imap()`]]

--

.pull-left.code90[


```r
# 1ä¸ªè¾“å…¥ç”¨map()
mu &lt;- list(5, 10, -3)
mu %&gt;% map(rnorm, n = 5)
```


```r
# 2ä¸ªè¾“å…¥å‘¢ï¼Ÿ
mu &lt;- list(5, 10, -3)
*sigma &lt;- list(1, 5, 10)
```


```r
# åšæŒç”¨map()ï¼
set.seed(1234)
seq_along(mu) %&gt;% 
  map(~ rnorm(5, mu[[.]], 
              sigma[[.]])) %&gt;% 
  str()
```

```
#&gt; List of 3
#&gt;  $ : num [1:5] 3.79 5.28 6.08 2.65 5.43
#&gt;  $ : num [1:5] 12.53 7.13 7.27 7.18 5.55
#&gt;  $ : num [1:5] -7.77 -12.98 -10.76 -2.36 6.59
```

]

--

.pull-right.code90[


```r
# è¿˜æ˜¯æ”¹ç”¨map2()å§ï¼Œ:)
set.seed(1234)
map2(mu, sigma, rnorm, n = 5) %&gt;% 
  str() # ç»“æœç›¸åŒ
```

```
#&gt; List of 3
#&gt;  $ : num [1:5] 3.79 5.28 6.08 2.65 5.43
#&gt;  $ : num [1:5] 12.53 7.13 7.27 7.18 5.55
#&gt;  $ : num [1:5] -7.77 -12.98 -10.76 -2.36 6.59
```

&lt;img src="imgs/map2-arg.png" width="100%" /&gt;

]

---

.full-width[.content-box-blue.bold.font120[å¤šä¸ªè¾“å…¥ï¼š`map2(.x, .y, .f, ...)`ã€.red[`pmap(.l, .f, ...)`] å’Œ `imap()`]]

--

.pull-left.code110[

```r
# æˆ‘è¿˜æƒ³è®©æŠ½æ ·æ ·æœ¬æ•°nä¹Ÿæœ‰æ‰€ä¸åŒï¼
n &lt;- list(1, 2, 3)
```


```r
# é»˜è®¤ä¸ºä½ç½®åŒ¹é…
args1 &lt;- list(n, mu, sigma)
args1 %&gt;%
  pmap(rnorm) %&gt;% str()
```

```
#&gt; List of 3
#&gt;  $ : num 4.03
#&gt;  $ : num [1:2] 4.46 3.74
#&gt;  $ : num [1:3] -8.24 -7.97 -21.06
```

]

--

.pull-right.code100[


```r
# ä½¿ç”¨å‘½åå‚æ•°åˆ—è¡¨ï¼ŒåŒ¹é….få‡½æ•°çš„å‚æ•°å
# ä¹Ÿå¯ç”¨æ•°æ®æ¡†ä½œä¸º.lå‚æ•°çš„å–å€¼
args2 &lt;- list(mean = mu, 
              sd = sigma, 
              n = n)
args2 %&gt;% 
  pmap(rnorm) %&gt;% str()
```

&lt;img src="imgs/pmap-3.png" width="95%" /&gt;

]

---

.full-width[.content-box-blue.bold.font120[å¤šä¸ªè¾“å…¥ï¼š`map2()`ã€`pmap()` å’Œ .red[`imap(.x, .f, ...)`]]]

.pull-left.font120[
`imap()`ä¸º _indexed map_ å‡½æ•°

- å½“è¾“å…¥å‘é‡ `.x` çš„å…ƒç´ æœ‰åç§°æ—¶ï¼Œå®ƒæ˜¯ `map2(.x, names(.x), ...)` çš„ç®€ä¾¿å†™æ³•

- å½“è¾“å…¥å‘é‡ `.x` çš„å…ƒç´ æ²¡æœ‰åç§°æ—¶ï¼Œå®ƒ `map2(.x, seq_along(.x), ...)` çš„ç®€ä¾¿å†™æ³•

- åœ¨ä½ éœ€è¦åŒæ—¶åŸºäº `.x` çš„å–å€¼å’Œåç§°/ç´¢å¼•è¿›è¡Œè®¡ç®—æ—¶ï¼Œ`imap(.x, .f, ...)` å¾ˆæœ‰ç”¨
]

--

.pull-right.code85[


```r
# å…ƒç´ æ²¡æœ‰åç§°ï¼Œ.y ä¸ºå…ƒç´ ä½ç½®
imap_chr(sample(LETTERS[1:4]), 
         ~ paste0(.y, " -&gt; ", .x))
```

```
#&gt; [1] "1 -&gt; B" "2 -&gt; D" "3 -&gt; C" "4 -&gt; A"
```

```r
# å…ƒç´ æœ‰åç§°ï¼Œ.y ä¸ºå…ƒç´ å
lst &lt;- map(1:4, ~ sample(1000, 10))
names(lst) &lt;- paste0("#", 1:4)
imap_chr(
  lst, 
  ~ glue::glue(
    "æ ·æœ¬{.y} çš„æœ€å¤§å€¼ä¸º {max(.x)}")
)
```

```
#&gt;                      #1 
#&gt; "æ ·æœ¬#1 çš„æœ€å¤§å€¼ä¸º 962" 
#&gt;                      #2 
#&gt; "æ ·æœ¬#2 çš„æœ€å¤§å€¼ä¸º 976" 
#&gt;                      #3 
#&gt; "æ ·æœ¬#3 çš„æœ€å¤§å€¼ä¸º 942" 
#&gt;                      #4 
#&gt; "æ ·æœ¬#4 çš„æœ€å¤§å€¼ä¸º 877"
```
]

---

.full-width[.content-box-blue.bold.font120[ä¸åŒè¾“å‡ºï¼š.red[`modify(.x, .f, ...)`] å’Œ `walk(.x, .f, ...)`]]

--

.pull-left.code100[

.full-width[.content-box-blue.bold[`modify()`ã€`modify2()` å’Œ `imodify()` æ€»æ˜¯è¿”å›ä¸è¾“å…¥å‘é‡ `.x` çš„ç±» `class` ç›¸åŒçš„å‘é‡]]


```r
df &lt;- data.frame(
  x = 1:3,
  y = 6:4
)

modify(df, ~ .x * 2)
```

```
#&gt;   x  y
#&gt; 1 2 12
#&gt; 2 4 10
#&gt; 3 6  8
```

]

.pull-right.code100[

.full-width[.content-box-blue.bold[ä½†å°½ç®¡ `modify()`ã€`modify2()` å’Œ `imodify()` å‡½æ•°åä¸­å«æœ‰ `modify`ï¼Œä½†å®ƒä»¬å¹¶ä¸ä¼šâ€œåŸåœ°ä¿®æ”¹â€è¾“å…¥å‘é‡ `.x`ï¼Œè€Œåªæ˜¯è¿”å›ä¿®æ”¹åçš„ç‰ˆæœ¬â€”â€”å¦‚æœä½ æƒ³æ°¸ä¹…ä¿ç•™ä¿®æ”¹ï¼Œå°±ä½ å¿…é¡»æ‰‹åŠ¨å°†è¿”å›ç»“æœèµ‹å€¼ç»™å˜é‡]]


```r
df
```

```
#&gt;   x y
#&gt; 1 1 6
#&gt; 2 2 5
#&gt; 3 3 4
```

```r
df &lt;- modify(df, ~ .x * 2)
```

]

---

.full-width[.content-box-blue.bold.font120[ä¸åŒè¾“å‡ºï¼š`modify(.x, .f, ...)` å’Œ .red[`walk(.x, .f, ...)`]]]

--

.pull-left.code85[

.full-width[.content-box-blue.bold[`walk()`ã€`walk2()`ã€`iwalk()` å’Œ `pwalk()`ï¼šè°ƒç”¨å‡½æ•°ä¸æ˜¯ä¸ºäº†å‡½æ•°çš„è¿”å›å€¼ï¼Œè€Œæ˜¯å‡½æ•°çš„â€œå‰¯ä½œç”¨â€ï¼ˆå¦‚æ•°æ®å­˜ç›˜ï¼‰ï¼›è¿™äº›å‡½æ•°éƒ½ä¼šä¸å¯è§åœ°è¿”å›ç¬¬ 1 ä¸ªè¾“å…¥é¡¹]]


```r
# ggsave(filename, plot=last_plot(), 
#   device = NULL, path = NULL, ...)

tmp &lt;- tempdir()
gs &lt;- mtcars %&gt;% 
  split(.$cyl) %&gt;% 
  map(~ ggplot(., aes(wt, mpg)) + 
        geom_point())
fs &lt;- str_c("cyl-", names(gs), ".pdf")

walk2(fs, gs, ggsave, path = tmp)
list.files(tmp, pattern = "^cyl-")
```

```
#&gt; [1] "cyl-4.pdf" "cyl-6.pdf" "cyl-8.pdf"
```

]

--

.pull-right.code80[


```r
# å‚æ•°ä½ç½®åŒ¹é…å¹¶ä½¿ç”¨ ... æ¥ä¼ é€’å‚æ•°
# æ›´æ¨èçš„åšæ³•æ˜¯ï¼š
walk2(
  fs, gs, 
  \(fs, gs) ggsave(fs, gs, path = tmp)
)
```

&lt;img src="imgs/walk2.png" width="70%" style="display: block; margin: auto;" /&gt;

]

---

.full-width[.content-box-blue.bold.font110[`map_dfr(.x, .f, ..., .id = NULL)` å’Œ `map_dfc(.x, .f, ...)`]]

.font110[
- åº”ç”¨ `dplyr` åŒ…çš„ `bind_rows()` æˆ– `bind_cols()` å¯¹ `map(.x, .f, ...)` è¾“å‡ºçš„å‘é‡è¿›è¡Œè¡Œ/åˆ—çš„åˆå¹¶ï¼Œè¿”å›æ•°æ®æ¡†ï¼ˆæ„Ÿå…´è¶£çš„åŒå­¦å¯çœ‹ä¸‹è¿™ä¸¤ä¸ªå‡½æ•°çš„æºä»£ç ï¼‰ã€‚
]

--

.full-width[.content-box-blue.bold.font110[`lmap(.x, .f, ...)`ã€`lmap_if(.x, .p, .f, ..., .else = NULL)` å’Œ `lmap_at(.x, .at, .f, ...)`]]

.font110[
- ç±»ä¼¼äº `map*()` å‡½æ•°ï¼Œä½†åªé€‚ç”¨äºè¾“å…¥å¹¶è¿”å› `list` æˆ– `data.frame` çš„å‡½æ•° `.f`ï¼Œä¹Ÿå°±æ˜¯è¯´ `.f` åº”ç”¨äº `.x` çš„**åˆ—è¡¨å…ƒç´ **è€Œéå…ƒç´ ï¼ˆå³ `.x[i]`ï¼Œè€Œé `.x[[i]]`ï¼‰ã€‚
]

--

.full-width[.content-box-blue.bold.font110[`map_if(.x, .p, .f, ..., .else = NULL)`ã€`map_at(.x, .at, .f, ...)` å’Œ `map_depth(.x, .depth, .f, ..., .ragged = FALSE)`]]

.font110[
- `map_if()` å°† `.f`ï¼ˆ`.else`ï¼‰åº”ç”¨äº `.x` ä¸­æ–­è¨€å‡½æ•° `.p` å–å€¼ä¸º `TRUE`ï¼ˆ`FALSE`ï¼‰çš„å…ƒç´ ï¼›
- `map_at()` å°† `.f` åº”ç”¨äº `.x` ä¸­ `.at` å‚æ•°ï¼ˆåç§°æˆ–ä½ç½®å‘é‡ï¼‰æ‰€æŒ‡å®šçš„å…ƒç´ ï¼›
- `map_depth()` å°† `.f` åº”ç”¨äºåµŒå¥—å‘é‡ `.x` ä¸­ `.depth` å‚æ•°æ‰€æŒ‡å®šæ·±åº¦çš„å…ƒç´ ï¼›
- `modify()` å’Œ `lmap()` ä¹Ÿæœ‰è¿™ç±»**æ¡ä»¶åº”ç”¨**çš„å˜ä½“å‡½æ•°ã€‚
]


---
layout: true

### &gt;&gt; 3.2 å…¶å®ƒ `purrr` åŒ…å‡½æ•°

---

.full-width[.content-box-blue.bold.font110[`reduce(.x, .f, ..., .init, .dir = c("forward", "backward"))` å’Œ `accumulate(.x, .f, ..., .init, .dir = c("forward", "backward"))`]]

--

.pull-left.code85[

```r
dfs &lt;- list(
  age = tibble(name = "Jo", age = 30),
  sex = tibble(name = c("Jo", "An"), 
               sex = c("M", "F")),
  trt = tibble(name = "An", 
               treatment = "A")
)
dfs %&gt;% reduce(full_join)
```

```
#&gt; # A tibble: 2 Ã— 4
#&gt;   name    age sex   treatment
#&gt;   &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;    
#&gt; 1 Jo       30 M     &lt;NA&gt;     
#&gt; 2 An       NA F     A
```


```r
1:10 %&gt;% accumulate(`+`)
```

```
#&gt;  [1]  1  3  6 10 15 21 28 36 45 55
```
]

--

.pull-right.font100[

&lt;img src="imgs/reduce-arg.png" width="95%" /&gt;

- `reduce()` å’Œ `accumulate()` æ”¯æŒçš„æ˜¯äºŒå…ƒå‡½æ•°ï¼Œå³æœ‰ä¸¤ä¸ªè¾“å…¥é¡¹çš„å‡½æ•°ï¼ˆåŠè¿ç®—ç¬¦ï¼‰
- è¿˜æœ‰`reduce2()` å’Œ `accumulate2()`å‡½æ•°

]

---

.full-width[.content-box-blue.bold.font120[æ”¯æŒæ–­è¨€å‡½æ•°ï¼ˆ_predicate functions_ï¼‰çš„æ³›å‡½]]

--

.pull-left.code85[

```r
# keep(.x, .p, ...) | discard()
iris %&gt;% 
  keep(is.numeric) %&gt;% 
  str(vec.len = 1)
```

```
#&gt; 'data.frame':	150 obs. of  4 variables:
#&gt;  $ Sepal.Length: num  5.1 4.9 ...
#&gt;  $ Sepal.Width : num  3.5 3 ...
#&gt;  $ Petal.Length: num  1.4 1.4 ...
#&gt;  $ Petal.Width : num  0.2 0.2 ...
```

```r
# compact(.x, .p = identity)
# remove all NULLs
```


```r
# every(.x, .p, ...) | some()
list(1:5, letters) %&gt;% 
  some(is_character)
```

```
#&gt; [1] TRUE
```
]
--

.pull-right.code85[

```r
set.seed(1234)

(x &lt;- sample(9))
```

```
#&gt; [1] 6 5 4 1 8 2 7 9 3
```

```r
# detect(.x, .f, ..., 
#   .dir = c("forward", "backward"), 
#   .right = NULL,.default = NULL)
# detect_index()
x %&gt;% detect(~ . &gt; 2)
```

```
#&gt; [1] 6
```

```r
# head_while(.x, .p, ...)|tail_while()
x %&gt;% head_while(~ . &gt; 2)
```

```
#&gt; [1] 6 5 4
```
]

---

.full-width[.content-box-blue.bold.font110[`safely(.f, otherwise = NULL, quiet = TRUE)`ã€`quietly()` å’Œ `possibly()`]]

- è¿™äº›å‡½æ•°å°±æ˜¯æ‰€è°“çš„å‡½æ•°è¿ç®—ç¬¦ï¼ˆ_function operator_ï¼‰â€”â€”ä»¥å‡½æ•°ä½œä¸ºå‚æ•°è¾“å…¥ï¼Œå¹¶è¿”å›å‡½æ•°ã€‚
- `safely()` ä¼šè°ƒæ•´å‡½æ•°çš„è¡Œä¸ºï¼ˆå‰¯è¯ï¼‰ï¼Œè®©è°ƒæ•´åçš„å‡½æ•°ä¸å†æŠ›å‡ºé”™è¯¯ï¼Œè€Œæ˜¯è¿”å›åŒ…å«ä¸¤ä¸ªå…ƒç´  `result` å’Œ `error` çš„åˆ—è¡¨ï¼›é€šè¿‡ `otherwise` å‚æ•°è®¾å®šé”™è¯¯æ—¶é»˜è®¤å€¼ï¼Œ`possibly()` æ€»æ˜¯æˆåŠŸï¼›è€Œ `quietly()` åˆ™ä¼šæ•æ‰å‘½ä»¤çš„ç»“æœã€è¾“å‡ºã€è­¦å‘Šå’Œæ¶ˆæ¯ã€‚

--

.pull-left.code70[


```r
x &lt;- list(1, 10, "a")
y &lt;- x %&gt;% map(safely(log)); str(y)
```

```
#&gt; List of 3
#&gt;  $ :List of 2
#&gt;   ..$ result: num 0
#&gt;   ..$ error : NULL
#&gt;  $ :List of 2
#&gt;   ..$ result: num 2.3
#&gt;   ..$ error : NULL
#&gt;  $ :List of 2
#&gt;   ..$ result: NULL
#&gt;   ..$ error :List of 2
#&gt;   .. ..$ message: chr "non-numeric argument to mathematical function"
#&gt;   .. ..$ call   : language .Primitive("log")(x, base)
#&gt;   .. ..- attr(*, "class")= chr [1:3] "simpleError" "error" "condition"
```

]

--

.pull-right.code70[

```r
y &lt;- transpose(y); str(y, give.attr = FALSE)
```

```
#&gt; List of 2
#&gt;  $ result:List of 3
#&gt;   ..$ : num 0
#&gt;   ..$ : num 2.3
#&gt;   ..$ : NULL
#&gt;  $ error :List of 3
#&gt;   ..$ : NULL
#&gt;   ..$ : NULL
#&gt;   ..$ :List of 2
#&gt;   .. ..$ message: chr "non-numeric argument to mathematical function"
#&gt;   .. ..$ call   : language .Primitive("log")(x, base)
```

```r
is_ok &lt;- y$error %&gt;% map_lgl(is_null)
y$result[is_ok] %&gt;% flatten_dbl()
```

```
#&gt; [1] 0.0 2.3
```
]

---

.full-width[.content-box-blue.bold.font120[`pluck(.x, ..., .default = NULL)` å’Œ `chuck(.x, ...)`ï¼šç”¨åç§°æˆ–ä½ç½®åˆ—è¡¨æ¥é€‰æ‹© `.x` ä¸­çš„ä¸€ä¸ªå…ƒç´ æˆ–å…¶å±æ€§ï¼ˆ+ `attr_getter()`ï¼‰]]

--

.full-width[.content-box-blue.bold.font120[`flatten(.x)`ã€`flatten_*(.x)` å’Œ `transpose(.l, .names = NULL)`ï¼šæ”¹å˜åˆ—è¡¨çš„å½¢çŠ¶]]

--

.full-width[.content-box-blue.bold.font120[`append(x, values, after = length(x))`ã€`prepend(x, values, before = NULL)` å’Œ `splice(...)`ï¼šå°†æ–°å…ƒç´  `values` å’Œåˆ—è¡¨ `x` åˆå¹¶]]

--

.full-width[.content-box-blue.bold.font120[`list_modify(.x, ...)` å’Œ `list_merge(.x, ...)`ï¼šæ ¹æ® `...` çš„å–å€¼ä¿®æ”¹/åˆå¹¶ `.x`]]

--

.full-width[.content-box-blue.bold.font120[`set_names(x, nm = x, ...)`ï¼šä»¥æ›´çµæ´»çš„æ–¹å¼è®¾ç½®åˆ—è¡¨ `x` çš„å…ƒç´ å]]

---

.full-width[.content-box-blue.bold.font120[`as_vector(.x, .type = NULL)`ã€`simplify(.x, .type = NULL)` å’Œ `simplify_all(.x, .type = NULL)`ï¼šå°†åˆ—è¡¨ `.x` è½¬åŒ–ä¸ºå‘é‡]]

--

.full-width[.content-box-blue.bold.font120[`array_branch(array, margin = NULL)` å’Œ `array_branch(array, margin = NULL)`ï¼šå°†æ•°ç»„è½¬åŒ–ä¸ºåˆ—è¡¨]]

--

.full-width[.content-box-blue.bold.font120[`has_element(.x, .y)`ï¼šåˆ—è¡¨ `.x` æ˜¯å¦åŒ…å«å…ƒç´  `.y`]]

--

.full-width[.content-box-blue.bold.font120[`vec_depth(x)`ï¼šè®¡ç®—å‘é‡ `x` çš„æ·±åº¦]]

--

.full-width[.content-box-blue.bold.font120[`cross(.l, .filter = NULL)` å’Œ `cross*()`ï¼šç”Ÿæˆåˆ—è¡¨å…ƒç´ çš„ç»„åˆ]]

--

.full-width[.content-box-blue.bold.font120[`auto_browse()`ã€`insistently()`ã€`slowly()`ã€`compose()`ã€`partial()`ã€`lift*()`ã€`rerun()`ã€`negate()`ï¼š_å‡½æ•°è¿ç®—ç¬¦_ï¼Œä¿®æ”¹å‡½æ•°çš„è¡Œä¸º]]

---
layout: false
class: inverse, center, middle

# 4. `purrr` åŒ… ä¸ åˆ—è¡¨åˆ—

.font150[( `purrr` _and list columns_ )]

---

&lt;img src="imgs/list_column_workflow.png" width="100%" /&gt;

--

.bold.font120[

- å°†ç»“æœå­˜å…¥ .font110[åˆ—è¡¨åˆ—] ä¸­ï¼Œå¯ç›´æ¥æå–ç»“æœå¹¶åŠ ä»¥åˆ†æï¼ˆè€Œæ— éœ€é‡æ–°è®¡ç®—ç»“æœï¼‰

- ä½ å·²ç»çŸ¥é“å¦‚ä½•æ“ä½œæ•°æ®è¡¨ï¼Œä½ å¯ä»¥å°†ä½ æŒæ¡çš„çŸ¥è¯†/æµç¨‹/å·¥å…·ç›´æ¥åº”ç”¨äºç”±ç»“æœæ„æˆçš„è¡¨æ ¼

]

---

### &gt;&gt; 4.1 æ­¥éª¤1ï¼šç”Ÿæˆåˆ—è¡¨åˆ—ï¼ˆlist columnï¼‰

--

.pull-left.code95[


```r
gapminder::gapminder
```

```
#&gt; # A tibble: 1,704 Ã— 6
#&gt;   country     contiâ€¦Â¹  year lifeExp
#&gt;   &lt;fct&gt;       &lt;fct&gt;   &lt;int&gt;   &lt;dbl&gt;
#&gt; 1 Afghanistan Asia     1952    28.8
#&gt; 2 Afghanistan Asia     1957    30.3
#&gt; 3 Afghanistan Asia     1962    32.0
#&gt; 4 Afghanistan Asia     1967    34.0
#&gt; 5 Afghanistan Asia     1972    36.1
#&gt; 6 Afghanistan Asia     1977    38.4
#&gt; # â€¦ with 1,698 more rows, 2 more
#&gt; #   variables: pop &lt;int&gt;,
#&gt; #   gdpPercap &lt;dbl&gt;, and
#&gt; #   abbreviated variable name
#&gt; #   Â¹â€‹continent
```

]

--

.pull-right.code90[

&lt;img src="imgs/magic.png" width="100%" style="display: block; margin: auto;" /&gt;


```r
by_cnty &lt;- gapminder::gapminder %&gt;% 
* tidyr::nest(
*   data = -c(country, continent))
by_cnty
```

```
*#&gt; # A tibble: 142 Ã— 3
#&gt;   country     continent data             
*#&gt;   &lt;fct&gt;       &lt;fct&gt;     &lt;list&gt;           
#&gt; 1 Afghanistan Asia      &lt;tibble [12 Ã— 4]&gt;
#&gt; 2 Albania     Europe    &lt;tibble [12 Ã— 4]&gt;
#&gt; 3 Algeria     Africa    &lt;tibble [12 Ã— 4]&gt;
#&gt; # â€¦ with 139 more rows
```

]

---

### &gt;&gt; 4.2 æ­¥éª¤2ï¼šå¤„ç†åˆ—è¡¨åˆ—

--

.pull-left.code90[


```r
# å°†çº¿æ€§å›å½’æ¨¡å‹lmåº”ç”¨äºdataåˆ—çš„æ¯ä¸ªå…ƒç´ ï¼Œ
# å›å½’ç»“æœï¼ˆåˆ—è¡¨ï¼‰å­˜ä¸ºæ–°çš„åˆ—è¡¨åˆ—model
by_cnty &lt;- by_cnty %&gt;% 
* mutate(
*   model = map(
      data, 
      ~ lm(lifeExp ~ year, 
           data = .x)
    )
  )
by_cnty
```

```
#&gt; # A tibble: 142 Ã— 4
#&gt;   country     continent data              model 
#&gt;   &lt;fct&gt;       &lt;fct&gt;     &lt;list&gt;            &lt;list&gt;
#&gt; 1 Afghanistan Asia      &lt;tibble [12 Ã— 4]&gt; &lt;lm&gt;  
#&gt; 2 Albania     Europe    &lt;tibble [12 Ã— 4]&gt; &lt;lm&gt;  
#&gt; 3 Algeria     Africa    &lt;tibble [12 Ã— 4]&gt; &lt;lm&gt;  
#&gt; 4 Angola      Africa    &lt;tibble [12 Ã— 4]&gt; &lt;lm&gt;  
#&gt; 5 Argentina   Americas  &lt;tibble [12 Ã— 4]&gt; &lt;lm&gt;  
#&gt; 6 Australia   Oceania   &lt;tibble [12 Ã— 4]&gt; &lt;lm&gt;  
#&gt; # â€¦ with 136 more rows
```

]

--

.pull-right.code100[


```r
# æå–modelåˆ—è¡¨åˆ—çš„ç¬¬1ä¸ªå…ƒç´ 
by_cnty %&gt;% pluck("model", 1)
# by_cnty$model[[1]]
```

```
#&gt; 
#&gt; Call:
#&gt; lm(formula = lifeExp ~ year, data = .x)
#&gt; 
#&gt; Coefficients:
#&gt; (Intercept)         year  
#&gt;    -507.534        0.275
```

]

---

### &gt;&gt; 4.3 æ­¥éª¤3ï¼šç®€åŒ–åˆ—è¡¨åˆ—

--

.pull-left.code95[


```r
# è¿˜æ˜¯ç”¨mutate + map_*æå–ä¿¡æ¯
by_cnty %&gt;% 
  mutate(
    coef_year = map_dbl(
      model, ~ coef(.x)[["year"]]
    )
  ) %&gt;% 
  select(-data, -model)
```

```
#&gt; # A tibble: 142 Ã— 3
#&gt;   country     continent coef_year
#&gt;   &lt;fct&gt;       &lt;fct&gt;         &lt;dbl&gt;
#&gt; 1 Afghanistan Asia          0.275
#&gt; 2 Albania     Europe        0.335
#&gt; 3 Algeria     Africa        0.569
#&gt; 4 Angola      Africa        0.209
#&gt; 5 Argentina   Americas      0.232
#&gt; 6 Australia   Oceania       0.228
#&gt; # â€¦ with 136 more rows
```

]

--

.pull-right.code90[


```r
# ä½¿ç”¨broomåŒ…ï¼Œæ›´å¼ºå¤§ã€ä¹Ÿæ›´æ–¹ä¾¿
# glance() | tidy() | augment()
by_cnty %&gt;%
* mutate(
    res = map(model, 
*             broom::glance)) %&gt;%
* tidyr::unnest(res) %&gt;%
  select(-c(data, model))
```

```
#&gt; # A tibble: 142 Ã— 14
#&gt;   country  contiâ€¦Â¹ r.squâ€¦Â² adj.râ€¦Â³ sigma statiâ€¦â´  p.value    df logLik   AIC   BIC deviaâ€¦âµ
#&gt;   &lt;fct&gt;    &lt;fct&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
#&gt; 1 Afghaniâ€¦ Asia      0.948   0.942 1.22    181.  9.84e- 8     1 -18.3  42.7  44.1   15.0  
#&gt; 2 Albania  Europe    0.911   0.902 1.98    102.  1.46e- 6     1 -24.1  54.3  55.8   39.3  
#&gt; 3 Algeria  Africa    0.985   0.984 1.32    662.  1.81e-10     1 -19.3  44.6  46.0   17.5  
#&gt; 4 Angola   Africa    0.888   0.877 1.41     79.1 4.59e- 6     1 -20.0  46.1  47.5   19.8  
#&gt; 5 Argentiâ€¦ Americâ€¦   0.996   0.995 0.292  2246.  4.22e-13     1  -1.17  8.35  9.80   0.854
#&gt; 6 Australâ€¦ Oceania   0.980   0.978 0.621   481.  8.67e-10     1 -10.2  26.4  27.9    3.85 
#&gt; # â€¦ with 136 more rows, 2 more variables: df.residual &lt;int&gt;, nobs &lt;int&gt;, and abbreviated
#&gt; #   variable names Â¹â€‹continent, Â²â€‹r.squared, Â³â€‹adj.r.squared, â´â€‹statistic, âµâ€‹deviance
```

]

---

### &gt;&gt; 4.4 [è¿›ä¸€æ­¥çš„ï¼ˆæ¢ç´¢æ€§ï¼‰åˆ†æ]

--

.code100[

```r
by_cnty %&gt;% 
  mutate(res = map(model, broom::glance)) %&gt;% 
  unnest(res) %&gt;% 
* ggplot(aes(continent, r.squared, colour = continent)) +
*   geom_jitter(width = 0.3) +
*   theme(legend.position = "none")
```

&lt;img src="L07_Iteration_files/figure-html/unnamed-chunk-66-1.png" width="50%" style="display: block; margin: auto;" /&gt;

]

---
layout: false
class: inverse, center, middle
background-image: url(imgs/sxc.png), url(imgs/purrr-furrr.png)
background-size: 100%, 40%
background-position: 0% 100%, 50% 45%

&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;

# &amp;nbsp;&amp;nbsp;&amp;nbsp; .font50[( `purrr` -&gt; `furrr` &lt;sup&gt;.font60[v0.3.1]&lt;/sup&gt; )]

---

### &gt;&gt; `furrr`: _Apply Mapping Functions in Parallel using Futures_

.pull-left.code85[


```r
library(tictoc) # for timing R scripts

by_cnty &lt;- gapminder::gapminder %&gt;% 
  tidyr::nest(
    data = -c(country, continent))

slow_lm &lt;- function(...) {
  Sys.sleep(0.1)
  lm(...)
}

tic()
by_cnty %&gt;% 
  mutate(
    model = map(
      data, 
      ~ slow_lm(lifeExp ~ year, 
                data = .x))
  ) -&gt; gc1
toc()
```

```
#&gt; 15.55 sec elapsed
```
]

--

.pull-right.code90[

```r
*library(furrr)

*plan(multisession, workers = 4)

tic()
by_cnty %&gt;% 
  mutate(
*   model = future_map(
      data, 
      ~ slow_lm(lifeExp ~ year, 
                data = .x)
    )
  ) -&gt; gc2
toc()
```

```
#&gt; 8.69 sec elapsed
```

```r
identical(gc1, gc2)
```

```
#&gt; [1] FALSE
```
]

---
layout: false
class: inverse, center, middle

# è¯¾åä½œä¸š

---
class: middle

### è¯¾åä½œä¸š

.font120[

1\. æ ¹æ®ç¬¬ä¸ƒè®²è¯¾ç¨‹è®²ä¹‰çš„æ‰“å°ç¨¿ï¼Œåœ¨ ğŸ“‘ _Rmd_ä¸­é”®å…¥å¹¶å®Œæˆä»£ç çš„è¿è¡Œ

2\. **å¤ä¹ ** ğŸ“– [_R for Data Science_](https://r4ds.had.co.nz/) ä¸€ä¹¦çš„ç¬¬21ç« å’Œç¬¬25ç« çš„å†…å®¹ï¼ˆä¸ºä¸­æ–‡ç¿»è¯‘ç‰ˆçš„ç¬¬16ç« å’Œç¬¬19ç« ï¼Œå…¶ä¸­ç¬¬19ç« è¢«å¤§é‡åˆ å‡ï¼‰ï¼Œå¹¶ï¼ˆç»“é˜Ÿï¼‰**å®Œæˆï¼ˆè‡ªé€‰ï¼‰è¯¾åç»ƒä¹ **ã€‚

3\. ä¸‹è½½ï¼ˆæ‰“å°ï¼‰ ğŸ“° [**{{`purrr` åŒ…çš„cheatsheet}}**](https://posit.co/wp-content/uploads/2022/10/purrr.pdf) å¹¶é˜…è¯»ä¹‹

4\. **å®Œæˆç¬¬ä¸ƒè®²çš„è¯¾åç»ƒä¹ ** ğŸ‘©â€ğŸ’»

&gt; .code90[

```r
remotes::install_github("qfwr2022/qfwr")
library(qfwr)
qfwr_ex("L07")
```
]

5\. æŠ½å‡ºæ—¶é—´æ¥**è‡ªå­¦** ğŸ“– [_R for Data Science_](https://r4ds.had.co.nz/) ä¸€ä¹¦å…³äº [å­—ç¬¦ä¸²](https://r4ds.had.co.nz/strings.html)ã€[å› å­](https://r4ds.had.co.nz/factors.html) å’Œ [æ—¥æœŸ-æ—¶é—´](https://r4ds.had.co.nz/dates-and-times.html) ç­‰ä¸‰ç§é‡è¦æ•°æ®ç±»å‹ä»¥åŠé‡è¦æ•°æ®å¤„ç†å‡½æ•°çš„å†…å®¹ï¼ˆä¸ºä¸­æ–‡ç¿»è¯‘ç‰ˆçš„ç¬¬10ç« ã€ç¬¬11ç« å’Œç¬¬12ç« ï¼‰ã€‚æˆ‘ä¹Ÿä¼šåœ¨è¯¾ç¨‹å¹³å°ä¸ŠæŒ‚å‡ºå¯¹åº”çš„ [{{è¯¾ä»¶}}](https://qfwr2022.netlify.app/weeks/week-x.html) ä¾›åŒå­¦ä»¬å‚è€ƒã€‚

]

---
class: center middle
background-image: url(imgs/xaringan.png)
background-size: 12%
background-position: 50% 40%


&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;
&lt;hr color='#f00' size='2px' width='80%'&gt;
&lt;br&gt;
.Large.red[_**æœ¬ç½‘é¡µç‰ˆè®²ä¹‰çš„åˆ¶ä½œç”± R åŒ… [{{`xaringan`}}](https://github.com/yihui/xaringan) èµ‹èƒ½ï¼**_]
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="../libs/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"ratio": "16:9",
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
